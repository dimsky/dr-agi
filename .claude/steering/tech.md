# 技术指导文档

## 技术架构原则

### 1. 现代化全栈架构
- 采用最新稳定版本的技术栈
- 优先选择类型安全的技术方案
- 追求开发效率和运行性能的平衡

### 2. 微服务友好设计
- 前后端分离，支持独立部署和扩展
- API优先设计，便于多端集成
- 服务模块化，支持动态配置和扩展

## 核心技术栈

### 前端技术栈

#### Next.js 15 全栈框架
- **App Router**：采用最新的文件系统路由
- **Server Components**：默认使用服务端组件提升性能
- **Client Components**：必要时使用客户端组件
- **Turbopack**：使用最新构建工具提升开发效率

#### React 19 生态
- **React 19**：最新React版本，支持并发特性
- **TypeScript 5**：严格类型检查，提升代码质量
- **React Hook Form**：高性能表单处理
- **Zod**：运行时类型验证

#### UI 组件系统
- **Tailwind CSS 4**：实用优先的CSS框架
- **shadcn/ui**：高质量可复用组件库
- **Radix UI**：无障碍访问的底层组件
- **Lucide React**：现代化图标库

### 后端技术栈

#### 数据库层
- **Supabase**：现代化PostgreSQL数据库服务
- **Drizzle ORM**：类型安全的数据库ORM
- **Database Migrations**：版本化数据库模式管理

#### 状态管理
- **TanStack React Query v5**：服务端状态管理
- **Server Actions**：Next.js原生的服务端操作
- **Real-time Subscriptions**：Supabase实时数据同步

### 认证与安全

#### 认证系统
- **JWT Token**：无状态的用户认证
- **WeChat Mini Program Login**：微信小程序原生登录
- **bcryptjs**：密码加密存储
- **Next.js Middleware**：路由级别的认证保护

#### 安全措施
- **HTTPS强制**：所有数据传输加密
- **CORS配置**：跨域请求安全控制
- **输入验证**：服务端和客户端双重验证
- **会话管理**：30分钟会话超时

### 外部服务集成

#### AI服务
- **Dify Workflow**：核心AI服务引擎
- **Dynamic Service Configuration**：动态服务配置能力
- **API Gateway Pattern**：统一的外部服务访问

#### 支付服务
- **WeChat Pay API**：微信原生支付集成
- **Order Management**：完整的订单生命周期管理
- **Payment Status Tracking**：支付状态实时跟踪

### 开发工具

#### 包管理和构建
- **pnpm**：高效的包管理器
- **Turbopack**：快速的构建工具
- **tsx**：TypeScript执行环境

#### 代码质量
- **ESLint 9**：代码规范检查
- **TypeScript Strict Mode**：严格类型检查
- **Drizzle Kit**：数据库模式管理工具

## 性能要求

### 页面性能
- **加载时间**：页面首次加载不超过3秒
- **交互响应**：用户操作响应时间小于200ms
- **资源优化**：图片和静态资源自动优化

### 文件处理
- **上传限制**：单文件最大50MB
- **格式支持**：PDF、Word、图片等医疗常用格式
- **病毒扫描**：文件上传安全检查

### 并发处理
- **用户并发**：支持100个用户同时访问
- **数据库连接**：连接池管理，避免连接泄漏
- **缓存策略**：React Query缓存 + 服务端缓存

## 安全要求

### 数据保护
- **加密存储**：敏感数据加密存储
- **传输加密**：HTTPS强制，数据传输加密
- **访问控制**：基于角色的权限管理
- **审计日志**：关键操作日志记录

### 医疗数据合规
- **隐私保护**：用户数据隐私保护
- **数据备份**：每日自动数据备份
- **灾难恢复**：数据恢复和业务连续性计划
- **合规审计**：定期安全审计和合规检查

## 可靠性要求

### 系统可用性
- **SLA目标**：99.9%系统可用性
- **监控告警**：实时系统监控和告警
- **健康检查**：API健康状态检查
- **故障恢复**：自动故障检测和恢复

### 错误处理
- **全局错误处理**：统一的错误处理机制
- **用户友好提示**：清晰易懂的错误信息
- **错误追踪**：完整的错误日志和追踪
- **降级策略**：服务降级和熔断机制

## 技术决策

### 为什么选择Next.js 15？
- **全栈能力**：单一框架解决前后端需求
- **性能优化**：Server Components和自动优化
- **开发体验**：Turbopack带来的快速开发体验
- **生态成熟**：丰富的生态和社区支持

### 为什么选择Drizzle ORM？
- **类型安全**：完整的TypeScript支持
- **性能优化**：零运行时开销
- **开发体验**：优秀的开发者工具和迁移管理
- **灵活性**：支持原生SQL和查询构建器

### 为什么选择Supabase？
- **开发效率**：快速搭建和部署
- **功能完整**：数据库、认证、实时通信一体化
- **可扩展性**：支持大规模应用需求
- **开源生态**：基于开源技术，避免厂商锁定

### 为什么选择TanStack Query？
- **服务端状态管理**：专注于API数据管理
- **缓存优化**：智能缓存和后台更新
- **开发体验**：优秀的DevTools和调试支持
- **性能优化**：减少不必要的网络请求

## 部署和运维

### 部署策略
- **容器化部署**：Docker容器化应用
- **持续集成**：自动化构建和测试
- **蓝绿部署**：零停机时间部署
- **环境隔离**：开发、测试、生产环境分离

### 监控和日志
- **应用监控**：性能监控和错误追踪
- **业务监控**：关键业务指标监控
- **日志管理**：结构化日志和日志聚合
- **告警机制**：及时的故障告警和通知

## 技术演进规划

### 短期优化（3个月）
- 完善监控和告警系统
- 优化数据库查询性能
- 建立自动化测试体系

### 中期升级（6-12个月）
- 引入更多AI服务集成
- 实现微服务架构拆分
- 建立完整的DevOps流程

### 长期规划（1-2年）
- 多地域部署和容灾
- 大数据分析和AI训练平台
- 开放API和生态建设