# 小程序手机号登录功能使用指南

## 功能概述

已成功在微信小程序中实现了手机号获取和登录功能，用户可以选择：
1. **手机号快速登录**（推荐）- 获取手机号并登录
2. **普通微信登录** - 仅使用微信基础信息登录

## 已更新的文件

### 1. 登录页面 (`pages/login/`)
- `login.js` - 新增手机号授权登录逻辑
- `login.wxml` - 新增两种登录方式的UI
- `login.wxss` - 新增登录按钮样式

### 2. 微信登录组件 (`components/wechat-auth/`)
- `wechat-auth.js` - 支持手机号获取和不同登录模式
- `wechat-auth.wxml` - 灵活的登录方式选择界面
- `wechat-auth.wxss` - 现代化的登录界面样式

### 3. 全局配置
- `app.js` - 更新API配置和功能开关

## 使用方法

### 方法一：在登录页面使用
登录页面已经集成了两种登录方式，用户可以直接选择：

```javascript
// 页面会自动调用相应的登录API
// 手机号登录 -> onLoginWithPhone()
// 普通登录 -> onLogin()
```

### 方法二：使用微信登录组件
在其他页面中使用登录组件：

```xml
<wechat-auth 
  enablePhoneNumber="{{true}}"
  loginMode="both"
  bindloginSuccess="onLoginSuccess"
  bindloginFail="onLoginFail"
>
</wechat-auth>
```

#### 组件属性说明：
- `enablePhoneNumber`: 是否启用手机号获取（默认true）
- `loginMode`: 登录模式
  - `"both"` - 显示两种登录方式（默认）
  - `"phone-first"` - 仅显示手机号登录
  - `"wechat-only"` - 仅显示微信登录
- `showButtonText`: 是否显示按钮文本（默认true）

## 配置说明

### API地址配置
在 `app.js` 中更新API地址：

```javascript
globalData: {
  // 开发环境
  apiBaseUrl: 'http://localhost:3000',
  // 生产环境 - 替换为实际域名
  // apiBaseUrl: 'https://your-domain.com',
}
```

### 功能开关
```javascript
features: {
  enablePhoneNumber: true,    // 是否启用手机号获取
  requirePhoneNumber: false,  // 是否强制要求手机号
}
```

## 登录流程

### 手机号登录流程（分步执行）：
1. 用户点击"手机号快速登录"
2. 微信弹出手机号授权弹窗，用户同意授权后获取 `phoneCode`
3. **立即调用** `wx.login()` 获取微信登录 `code`
4. **第一步**：先调用 `/api/auth/wechat` 进行普通微信登录
5. **第二步**：登录成功后，用获得的 token 调用 `/api/auth/phone` 更新手机号
6. 更新本地存储的用户信息，包含手机号
7. 显示"登录成功，已获取手机号"

### 普通微信登录流程：
1. 用户点击"微信登录"
2. 获取微信登录 `code`
3. 调用 `/api/auth/wechat` 进行登录（不包含phoneCode）
4. 后端验证并返回用户信息（不包含手机号）
5. 保存登录状态到本地存储

## 用户体验优化

### 1. 登录状态提示
- 手机号登录：显示"登录成功，已获取手机号"
- 普通登录：显示"登录成功"
- 授权中状态：显示"正在授权中..."

### 2. 错误处理
- 用户拒绝手机号授权：提示"需要获取手机号才能继续"
- 网络错误：提示"网络连接失败，请检查网络后重试"
- API错误：显示具体错误信息

### 3. 界面设计
- 手机号登录按钮显示"推荐"标签
- 不同按钮样式区分主次操作
- 加载状态动画和禁用样式
- 登录提示说明功能差异

## 注意事项

### 1. 微信API限制
- 手机号授权码(`phoneCode`)有效期5分钟
- 每个授权码只能使用一次
- 不能与微信登录码(`wx.login`的code)混用

### 2. 权限配置
需要在微信公众平台配置：
- 服务器域名白名单
- 获取用户手机号权限

### 3. 环境变量
确保后端配置了相应的环境变量：
```
WECHAT_APPID=你的小程序AppID
WECHAT_SECRET=你的小程序AppSecret
JWT_SECRET=你的JWT密钥
```

## 测试建议

1. **手机号登录测试**：
   - 用户同意授权的情况
   - 用户拒绝授权的情况
   - 网络异常情况

2. **普通登录测试**：
   - 基础微信登录功能
   - 登录后的用户信息显示

3. **组件集成测试**：
   - 不同`loginMode`的显示效果
   - 登录成功/失败事件触发

## 技术亮点

1. **灵活的架构设计** - 支持多种登录模式配置
2. **完善的错误处理** - 针对各种异常情况的友好提示
3. **现代化的UI设计** - 直观的用户界面和交互反馈
4. **统一的状态管理** - 全局登录状态和本地存储同步
5. **可扩展性强** - 易于添加新的登录方式或功能

---

现在用户可以在微信小程序中享受更安全、便捷的手机号登录体验！